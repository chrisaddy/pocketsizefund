#!/usr/bin/env bash

# build model image

set -e

directory_name=$1

if [[ -z "$directory_name" ]]; then
    echo "valid directory name required:"
    echo ""
    ls -li exp | awk '{print $NF}' | tail -n +2
    echo ""
    exit 0
fi

directory_suffix=$2

if [[ -z "$directory_suffix" ]]; then
    echo "valid directory name required:"
    echo ""
    echo "train"
    echo "invoke"
    echo ""
    exit 0
fi

account_id=$(aws sts get-caller-identity --query Account --output text)

image_name=$(python3 ./bin/helpers/rename_resource.py ${directory_name})-$directory_suffix

tag=${image_name}:latest

# note the platform amd64
docker build \
    --file ./exp/${directory_name}/dockerfile_${directory_suffix} \
    --platform linux/amd64  \
    --tag ${tag} .

account_region=$(aws --profile default configure get region)

target_image=${account_id}.dkr.ecr.${account_region}.amazonaws.com/${tag}

docker tag ${image_name} ${target_image}
