#!/usr/bin/env bash

# creates and starts up SAM resources in the
# AWS account

set -e

environment="development"
if [[ "$1" == "production" ]]; then
    environment="production"
fi

sam deploy \
    --no-confirm-changeset \
    --resolve-image-repos \
    --on-failure DELETE \
    --config-env ${environment}

python3 ./bin/helpers/set_invite_base_url_environment_variable.py ${environment}

users_table=$(aws cloudformation describe-stacks \
    --stack-name pocketsizefund-${environment} \
    --query 'Stacks[0].Outputs[?OutputKey==`UsersTable`].OutputValue' \
    --output text)

python3 ./bin/helpers/upload_users_table.py ${environment} ${users_table}