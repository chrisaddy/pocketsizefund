#!/usr/bin/env bash

# creates and starts up SAM resources in the
# AWS account

set -e

environment="development"
if [[ "$1" == "production" ]]; then
    environment="production"
fi

sam deploy \
    --no-confirm-changeset \
    --resolve-image-repos \
    --on-failure DELETE \
    --config-env $environment

python3 ./bin/helpers/set_invite_base_url_environment_variable.py $environment

AWS_PAGER="" aws dynamodb import-table \
    --s3-bucket-source S3Bucket=pocketsizefund-artifacts,S3KeyPrefix=users_table_data \
    --input-format DYNAMODB_JSON \
    --table-creation-parameters '{
        "TableName": "pocketsizefund-'${environment}'-users",
        "KeySchema": [
            {
                "AttributeName": "id",
                "KeyType": "HASH"
            }
        ],
        "AttributeDefinitions": [
            {
                "AttributeName": "id",
                "AttributeType": "S"
            }
        ],
        "BillingMode": "PAY_PER_REQUEST"
    }' \
    --no-paginate
